<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ChatGPT Conversation Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; height: 100vh; display: flex; flex-direction: column; }
        #drop-zone { flex: 1; border: 3px dashed #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        #drop-zone.dragover { background: #f0f8ff; border-color: #007acc; }
        #app { flex: 1; display: flex; height: 0; overflow: hidden; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }
        #minimap { width: 300px; background: #f8f9fa; border-left: 1px solid #dee2e6; display: flex; flex-direction: column; }
        .minimap-header { padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600; }
        .bookmark { padding: 8px 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .bookmark:hover { background: #e9ecef; }
        .message { margin-bottom: 24px; max-width: 80%; animation: fadeIn 0.3s; }
        .user { margin-left: auto; }
        .assistant { margin-right: auto; }
        .message-content { padding: 16px 20px; border-radius: 18px; line-height: 1.5; white-space: pre-wrap; }
        .user .message-content { background: #007acc; color: white; }
        .assistant .message-content { background: #f1f3f4; }
        .bookmark-btn { position: fixed; top: 20px; right: 20px; background: #007acc; color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .copy-snippet-btn { position: fixed; top: 20px; left: 20px; background: #28a745; color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .scroll-indicator { position: absolute; right: -4px; width: 4px; background: #007acc; border-radius: 2px; transition: height 0.1s; }
    </style>
</head>
<body>
    <input type="file" id="file-input" accept=".json" style="display: none;">
    <div id="drop-zone">
        <div style="text-align: center;">
            <button class="copy-snippet-btn" onclick="copySnippet(event)" style="position: static; margin-bottom: 20px;">ðŸ“‹ Copy Export Snippet</button>
            <div>Drag & drop your ChatGPT JSON file here or click to browse</div>
        </div>
    </div>
    <div id="app" style="display: none;">
        <button class="bookmark-btn" onclick="addBookmark()">ðŸ“Œ Bookmark Here</button>
        <div id="chat"></div>
        <div id="minimap">
            <div class="minimap-header">Bookmarks</div>
            <div id="bookmarks-list"></div>
        </div>
    </div>

    <script>
        let conversation = [];
        let bookmarks = [];

        const dropZone = document.getElementById('drop-zone');
        const app = document.getElementById('app');
        const chat = document.getElementById('chat');
        const bookmarksList = document.getElementById('bookmarks-list');
        const fileInput = document.getElementById('file-input');

        // File handling
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

        function handleFile(file) {
            if (!file || !file.name.endsWith('.json')) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    conversation = data.chats || data.messages || data.conversation || [];
                    renderChat();
                    app.style.display = 'flex';
                    dropZone.style.display = 'none';
                } catch (err) {
                    alert('Invalid JSON file');
                }
            };
            reader.readAsText(file);
        }

        function renderChat() {
            chat.innerHTML = conversation.map((msg, i) => `
                <div class="message ${msg.role}" data-index="${i}">
                    <div class="message-content">${msg.content || msg.text || ''}</div>
                </div>
            `).join('');
            
            // Scroll events
            const messages = chat.querySelectorAll('.message');
            chat.onscroll = () => {
                const scrollTop = chat.scrollTop;
                const scrollHeight = chat.scrollHeight - chat.clientHeight;
                const scrollPercent = scrollTop / scrollHeight;
                
                // Update minimap scroll indicator
                const activeMsg = Array.from(messages).find(msg => {
                    const rect = msg.getBoundingClientRect();
                    return rect.top < chat.clientHeight / 2 && rect.bottom > chat.clientHeight / 2;
                });
                
                if (activeMsg) {
                    const index = parseInt(activeMsg.dataset.index);
                    updateActiveBookmark(index);
                }
            };
        }

        function addBookmark() {
            const scrollTop = chat.scrollTop;
            const messages = Array.from(chat.querySelectorAll('.message'));
            const activeIndex = messages.findIndex(msg => {
                const rect = msg.getBoundingClientRect();
                return rect.top <= 50 && rect.bottom >= 50;
            });
            
            const title = prompt('Bookmark title:') || `Message ${activeIndex}`;
            if (title) {
                bookmarks.push({ title, scrollTop, index: activeIndex >= 0 ? activeIndex : 0 });
                renderBookmarks();
            }
        }

        function renderBookmarks() {
            bookmarksList.innerHTML = bookmarks.map((b, i) => `
                <div class="bookmark" onclick="jumpToBookmark(${i})">
                    ðŸ“Œ ${b.title}
                </div>
            `).join('');
        }

        function jumpToBookmark(index) {
            const bookmark = bookmarks[index];
            chat.scrollTo({ top: bookmark.scrollTop, behavior: 'smooth' });
        }

        function updateActiveBookmark(index) {
            // No longer highlights active bookmark
        }

        function copySnippet(event) {
            if (event) event.stopPropagation();
            const snippet = `(async () => {
  const scrollContainer = document.querySelector('main [class*="react-scroll-to-bottom"]')?.firstChild
    || document.querySelector('[class*="overflow-y-auto"]');

  if (!scrollContainer) {
    console.error('Could not find scroll container');
    return;
  }

  const messagesMap = new Map();

  const captureVisible = () => {
    document.querySelectorAll('[data-message-author-role]').forEach(el => {
      const role = el.getAttribute('data-message-author-role');
      const content = el.querySelector('[data-message-preview]')?.innerText || el.innerText.trim();
      const key = \`\${role}:\${content.slice(0, 100)}\`;

      if (!messagesMap.has(key)) {
        // Use vertical position as order
        const rect = el.getBoundingClientRect();
        const absoluteTop = rect.top + scrollContainer.scrollTop;

        messagesMap.set(key, {
          role,
          content,
          top: absoluteTop
        });
      }
    });
  };

  // Start at top
  scrollContainer.scrollTop = 0;
  await new Promise(r => setTimeout(r, 500));
  captureVisible();

  // Scroll through, capturing as we go
  let lastScrollTop = -1;
  while (scrollContainer.scrollTop !== lastScrollTop) {
    lastScrollTop = scrollContainer.scrollTop;
    scrollContainer.scrollTop += scrollContainer.clientHeight * 0.8;
    await new Promise(r => setTimeout(r, 300));
    captureVisible();
  }

  // Sort by vertical position
  const messages = Array.from(messagesMap.values())
    .sort((a, b) => a.top - b.top)
    .map(({ role, content }) => ({ role, content }));

  const json = {
    meta: {
      title: document.querySelector('h1')?.innerText || 'ChatGPT Conversation',
      exportedAt: new Date().toISOString(),
      messageCount: messages.length
    },
    messages
  };

  const dataStr = JSON.stringify(json, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(dataBlob);
  link.download = 'chatgpt-conversation.json';
  link.click();

  console.log(\`Exported \${messages.length} messages\`);
})();`;

            navigator.clipboard.writeText(snippet).then(() => {
                alert('Snippet copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy snippet');
            });
        }

    </script>
</body>
</html>

